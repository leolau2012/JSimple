// JavaScript Document
var touchScroll=function(e,t,n,r){this.holder=$("#"+e),this.scroller=$("#"+t),this.speed=n,this.scrollEndFunc=r||function(){},this.init()};touchScroll.prototype={init:function(){var e=this;e.minDistance=10,e.startPos={x:0,y:0},e.pointX=0,e.enableScroll=!1,e.dir="",e.scrollWidth=e.holder.width(),e.totalWidth=e.scroller.width(),e.currPage=1,e.totalPage=Math.floor(e.totalWidth/e.scrollWidth),e.maxWidth=e.totalWidth-e.scrollWidth,e.holder.on("touchstart",function(t){e.start(t)}),e.holder.on("touchmove",function(t){e.move(t)}),e.holder.on("touchend",function(t){e.end(t)}),$(window).on("resize",function(){e.refresh()})},refresh:function(){var e=this;e.scrollWidth=e.holder.width(),e.totalWidth=e.scroller.width(),e.maxWidth=e.totalWidth-e.scrollWidth,e.scrollToPage(e.currPage)},start:function(e){var t=this;t.startPos.x=e.touches[0].pageX,t.startPos.y=e.touches[0].pageY,t.enableScroll=!1},move:function(e){var t=this,n=e.touches[0].pageX,r=e.touches[0].pageY,i=n-t.startPos.x,s=r-t.startPos.y;t.dir=i>0?"right":"left";if(Math.abs(i)>t.minDistance&&Math.abs(i)>Math.abs(s)){e.preventDefault();var o=t.pointX+i;t.dir=="right"?o-=t.minDistance:o+=t.minDistance;if(o<-t.maxWidth||o>0)return;t.scroller[0].style.webkitTransform="translate("+o+"px, 0px) scale(1) translate3d(0,0,0)",t.enableScroll=!0}},end:function(e){var t=this;if(!t.enableScroll)return;t.enableScroll=!1;var n=0;t.dir=="right"?(n=t.pointX+t.scrollWidth,t.currPage--):(n=t.pointX-t.scrollWidth,t.currPage++),n<-t.maxWidth&&(n=-t.maxWidth),n>0&&(n=0),t.currPage>t.totalPage&&(t.currPage=t.totalPage),t.currPage<1&&(t.currPage=1),t.pointX=n,t.scroller[0].style.webkitTransform="translate("+n+"px, 0px) scale(1) translate3d(0,0,0)",t.scroller[0].style.webkitTransitionProperty="transform",t.scroller[0].style.webkitTransitionDuration=t.speed+"s",t.scroller[0].style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)",t.scrollEndFunc(t.currPage)},scrollToPage:function(e){var t=this,n=(1-e)*t.scrollWidth;t.pointX=n,t.scroller[0].style.webkitTransform="translate("+n+"px, 0px) scale(1) translate3d(0,0,0)",t.scroller[0].style.webkitTransitionProperty="transform",t.scroller[0].style.webkitTransitionDuration=t.speed+"s",t.scroller[0].style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)",t.currPage=e,t.scrollEndFunc(t.currPage)}};var news={ele:{holder:$("#news-list"),more:$("#load-more"),loadingMore:$("#loading-more"),focus:$("#focus"),hotwordWrapper:$("#hotword-wrapper"),showImg:$("#showImg"),nav:$("#nav-wrapper")},data:{cats:[],currCat:"",cache:{},num:20,maxNum:160,ajax:null,hotwordAnimTimer:null,hotScroll:null,focusScroll:null,isShowImg:1,needToTop:!0,loading:'<li id="loading"><div></div></li>',loadingError:'<li id="loadError">\u52a0\u8f7d\u5931\u8d25\uff0c\u8bf7\u70b9\u51fb\u5237\u65b0\u3002<div id="loadingReload"></div></li>',loadmore:"\u6b63\u5728\u52a0\u8f7d\u4e2d...",loadmoreError:'<div id="loadmoreReload">\u52a0\u8f7d\u5931\u8d25\uff0c\u70b9\u51fb\u91cd\u65b0\u52a0\u8f7d\u3002</div>',request:{news:"http://sh.qihoo.com/api/webapp/topnews.json?num=",others:"http://m.news.so.com/index.php?c=Clientapi&a=class&cls={cat}&limit="}},init:function(){var e=this;e.fixNav(),e.getCats(),e.getHash(),e.getImgFlag(),e.initCat(),e.initLinks(),e.initScroll(),e.initHotword(),e.startHotwordAnim(),e.loadData(!1),e.initMore()},fixNav:function(){var e=this;$(window).on("scroll touchmove",function(){$(document.body).scrollTop()>97?e.ele.nav.addClass("fix"):e.ele.nav.removeClass("fix")})},initScroll:function(){var e=this;new iScroll("nav-wrapper",{scrollbarClass:"myScrollbar",bounce:!1}),e.data.isShowImg&&(e.loadFocusImg(),e.data.focusScroll=new touchScroll("focus-wrapper","focus-scroller",.5,function(e){$("#indicator .active").removeClass("active"),$("#indicator li").eq(e-1).addClass("active")}))},initHotScroll:function(){var e=this;e.data.hotScroll=new touchScroll("hotword-expand","ex-scroller",.5,function(e){$("#indicator2 .active").removeClass("active"),$("#indicator2 li").eq(e-1).addClass("active")})},initHotword:function(){var e=this;$("#hotword-anim-wrapper").bind("tap",function(){var t=$("#hotword-wrapper");t.hasClass("down")?(t.removeClass("down"),$("#hotword-expand").hide(),$("#indicator2").hide(),$("#hotword li").removeClass("hidden"),e.startHotwordAnim()):(t.addClass("down"),$("#hotword-expand").show(),$("#indicator2").show(),$("#hotword li").addClass("hidden"),e.stopHotwordAnim(),e.data.hotScroll?e.data.hotScroll.refresh():e.initHotScroll())})},loadFocusImg:function(){var e=this;$("#focus-scroller li").each(function(e,t){var n=$(t),r=n.data("img");n.height(Math.round(n.width()/2)),r&&n.prepend($("<img src='"+r+"' />"))}),$(window).on("resize",function(){$("#focus-scroller li").each(function(e,t){var n=$(t);n.height(Math.round(n.width()/2))})})},startHotwordAnim:function(){var e=this;e.data.hotwordAnimTimer=setInterval(function(){$("#hotword").addClass("anim"),setTimeout(function(){$("#hotword li").first().appendTo($("#hotword")),$("#hotword").removeClass("anim")},1500)},3e3)},stopHotwordAnim:function(){clearInterval(this.data.hotwordAnimTimer)},getImgFlag:function(){var e=this,t=e.getCookie("showimg");t!=""&&t=="0"?(e.data.isShowImg=0,e.ele.showImg.html("\u6709\u56fe")):(e.data.isShowImg=1,e.ele.showImg.html("\u65e0\u56fe")),e.ele.showImg.on("click",function(){e.data.isShowImg=="1"?e.setCookie("showimg","0",{expireDays:365,path:"/"}):e.setCookie("showimg","1",{expireDays:-1,path:"/"}),location.reload()})},setCookie:function(e,t,n){var r=e+"="+encodeURIComponent(t);if(n){if(n.expireDays){var i=new Date,s=n.expireDays*24*3600*1e3;i.setTime(i.getTime()+s),r+="; expires="+i.toGMTString()}n.path&&(r+="; path="+n.path),n.domain&&(r+="; domain"+n.domain),n.secure&&(r+="; secure")}document.cookie=r},getCookie:function(e){var t=document.cookie.split("; ");for(var n=0;n<t.length;n++){var r=t[n].split("=");if(r[0]==e)return decodeURIComponent(r[1])}return""},getCats:function(){var e=this;$("#nav-scroller a").each(function(t,n){e.data.cats.push(n.getAttribute("href").replace("#",""))}),e.data.cats.length>0&&(e.data.currCat=e.data.cats[0])},getHash:function(){var e=this,t=location.hash;t&&(t=t.replace("#",""),e.checkCat(t)&&(e.data.currCat=t))},checkCat:function(e){return $.inArray(e,this.data.cats)>-1?!0:!1},initCat:function(){var e=this;$("#nav-scroller").on("click","a",function(){var t=this.getAttribute("href").replace("#","");$(document.body).scrollTop()>=97?(e.data.needToTop=!0,e.scrollToView()):e.data.needToTop=!1,e.checkCat(t)&&t!=e.data.currCat&&(e.data.currCat=t,e.loadData(!1)),e.setSelected(),e.displayOtherArea()}),e.setSelected(),e.displayOtherArea()},initLinks:function(){$(document.body).on("tap",".news-item",function(e){if($(this).hasClass("type-zhuanti")){window.location=$(this).data("url");return}var t=$(this).data("m"),n=$(this).data("url"),r=e.target.parentNode.id==="focus-scroller"?"home_focus":"home",i="http://m.news.so.com/ns?a=transcode&src="+r+"&m="+encodeURIComponent(t)+"&u="+encodeURIComponent(n);window.location=i}),$("#hotword-wrapper [data-q]").on("tap",function(e){e.preventDefault(),e.stopPropagation();var t="/ns?&src=home_hotword&q="+encodeURIComponent($(this).data("q"));window.location=t})},displayOtherArea:function(){var e=this;e.data.currCat=="news"?(e.data.isShowImg&&e.ele.focus.show(),e.ele.hotwordWrapper.show(),e.data.focusScroll&&e.data.focusScroll.refresh()):(e.ele.focus&&e.ele.focus.hide(),e.ele.hotwordWrapper.hide())},setSelected:function(){$("#nav-scroller li.active").removeClass("active"),$("#nav-scroller li").has('a[href="#'+this.data.currCat+'"]').addClass("active")},initMore:function(){var e=this;$("#load-more").on("click",function(){e.loadData(!0)}),$("#loading-more").delegate("#loadmoreReload","click",function(){e.loadData(!0)})},loadData:function(e){var t=this,n=t.data.cache[t.data.currCat];if(typeof n!="undefined"&&!e)t.displayResult();else{var r=t.data.request.others.replace(/{cat}/gi,t.data.currCat);t.data.currCat=="news"&&(r=t.data.request.news),r+=t.data.num,e&&(r+="&pos="+t.data.cache[t.data.currCat].pos),t.data.ajax&&t.data.ajax.abort(),t.data.ajax=$.ajax({url:r,type:"get",dataType:"json",beforeSend:function(){e?t.showLoadingMore():t.showLoading(),t.hideMoreBtn()},error:function(){e?t.showLoadingMoreError():t.showLoadingError()},success:function(n){if(!n)return;n.code==0?(t.saveData(n),t.displayResult(),!e&&t.data.needToTop&&t.scrollToView()):e?t.showLoadingMoreError():t.showLoadingError()}})}},scrollToView:function(){var e=this;$("#nav-holder")[0].scrollIntoView(!0)},showLoading:function(){this.ele.holder.html(this.data.loading)},showLoadingError:function(){this.ele.holder.html(this.data.loadingError),$("#loadingReload").click(function(){location.reload()})},showLoadingMore:function(){var e=this;e.ele.loadingMore.html(e.data.loadmore).show(),e.hideMoreBtn()},hideLoadingMore:function(){this.ele.loadingMore.hide()},showLoadingMoreError:function(){var e=this;e.ele.loadingMore.html(e.data.loadmoreError).show()},showMoreBtn:function(){this.ele.more.show()},hideMoreBtn:function(){this.ele.more.hide()},isExist:function(e){var t=this,n=!1,r=t.data.currCat,i=t.data.cache[r].result;for(var s=0;s<i.length;s++){var o="newstitle",u="newsurl";r=="news"&&(o="title",u="url");if(e[o]==i[s][o]||e[u]==i[s][u]){n=!0;break}}return n},saveData:function(e){var t=this,n=t.data.currCat;typeof t.data.cache[n]=="undefined"?(t.data.cache[n]={},t.data.cache[n].result=e.result,t.data.cache[n].total=0):e.result.forEach(function(e){t.isExist(e)||t.data.cache[n].result.push(e)}),n=="news"?t.data.cache[n].pos=t.data.num+e.pos:t.data.cache[n].pos=e.pos,t.data.cache[n].total+=t.data.num},displayResult:function(){var e=this,t=e.data.currCat,n=e.data.cache[t].result,r=[];if(t=="news"){var i='<li class="news"><a href="{{_url}}">{{_imgurl}}<div class="news-text"><h3>{{title}}{{_hot}}</h3><p>{{description}}</p></div><div class="info"><time>{{recordTime}}</time></div></li>';n.forEach(function(t,n,s){e.data.isShowImg&&t.image_url?(t._className=" has-photo",t._imgurl='<img class="news-img" src="'+t.image_url+'">'):(t._className="",t._imgurl=""),t._url="http://m.news.so.com/ns?a=transcode&src=home&m="+encodeURIComponent(t.m)+"&u="+encodeURIComponent(t.url),t._hot=t.recordTime==""?"<span class='hot'></span>":"";var o=i.replace(/{{([^{}]+)}}/g,function(e,n){return t[n]});r.push(o)})}else{var i='<li><a href="{{_url}}">{{_imgurl}}<div class="news-text"><h3>{{newstitle}}</h3><p>{{description}}</p></div><div class="info"><site>\u6765\u81ea:&nbsp;{{src}}</site><time>{{pdate}}</time></div></a></li>';n.forEach(function(t,n,s){e.data.isShowImg&&t.imgurl?(t._className=" has-photo",t._imgurl='<img class="news-img" src="'+t.imgurl+'">'):(t._className="",t._imgurl=""),t._url="http://m.news.so.com/ns?a=transcode&src=home&m="+encodeURIComponent(t.m)+"&u="+encodeURIComponent(t.newsurl);var o=i.replace(/{{([^{}]+)}}/g,function(e,n){return t[n]});r.push(o)})}e.ele.holder.html(r.join("")),e.data.cache[t].total>=e.data.maxNum?e.hideMoreBtn():e.showMoreBtn(),e.hideLoadingMore()}};news.init();